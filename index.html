<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Add Student</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
*{box-sizing:border-box;}
body{
  margin:0;
  font-family:Arial;
  background:linear-gradient(135deg,#4e73df,#1cc88a);
  display:flex;
  justify-content:center;
  align-items:center;
  min-height:100vh;
  padding:15px;
}
.card{
  background:white;
  width:100%;
  max-width:420px;
  padding:20px;
  border-radius:15px;
  box-shadow:0 10px 25px rgba(0,0,0,0.2);
}
h2{text-align:center;}
input{
  width:100%;
  padding:12px;
  margin-bottom:12px;
  border-radius:8px;
  border:1px solid #ccc;
  font-size:16px;
}
button{
  width:100%;
  padding:14px;
  border:none;
  border-radius:8px;
  font-size:16px;
  font-weight:bold;
  cursor:pointer;
  margin-top:10px;
}
.add{background:#f6c23e;}
.view{background:#36b9cc;color:white;}
</style>
</head>

<body>

<div class="card">
<h2>Add Student</h2>

<input id="name" placeholder="Student Name">
<input id="class" placeholder="Class">
<input id="room_no" placeholder="Room No">
<input id="parent_name" placeholder="Parent Name">

<input id="parent_phone1" placeholder="Parent Phone 1 (10 digits)" maxlength="10">
<input id="parent_phone2" placeholder="Parent Phone 2 (10 digits)" maxlength="10">
<input id="student_phone" placeholder="Student Phone (10 digits)" maxlength="10">

<input type="file" id="photo">

<button id="addBtn" class="add">Add Student</button>
<button class="view" onclick="location.href='view-students.html'">View Students</button>
</div>

<script>
var supabaseUrl="https://nqobmiqnwdldranpyxsl.supabase.co";
var supabaseKey="sb_publishable_eQReGHybx0Oj9G65eqWn-w_x_OjsbWB";
var client=supabase.createClient(supabaseUrl,supabaseKey);

function validatePhone(num){
  var regex=/^[0-9]{10}$/;
  return regex.test(num);
}

async function compressImage(file){
  return new Promise(function(resolve){
    var reader=new FileReader();
    reader.readAsDataURL(file);
    reader.onload=function(e){
      var img=new Image();
      img.src=e.target.result;
      img.onload=function(){
        var canvas=document.createElement("canvas");
        var ctx=canvas.getContext("2d");
        var maxWidth=500;
        var scale=maxWidth/img.width;
        canvas.width=maxWidth;
        canvas.height=img.height*scale;
        ctx.drawImage(img,0,0,canvas.width,canvas.height);
        canvas.toBlob(function(blob){
          resolve(blob);
        },"image/jpeg",0.7);
      };
    };
  });
}

async function generateHST(){
  var response=await client.from("students")
    .select("hst_number")
    .order("id",{ascending:false})
    .limit(1);

  var data=response.data;
  var next=1;

  if(data && data.length>0){
    next=parseInt(data[0].hst_number.replace("HST",""))+1;
  }

  return "HST"+("000"+next).slice(-3);
}

document.getElementById("addBtn").addEventListener("click",async function(){

  var p1=document.getElementById("parent_phone1").value.trim();
  var p2=document.getElementById("parent_phone2").value.trim();
  var sp=document.getElementById("student_phone").value.trim();

  if(!validatePhone(p1) || !validatePhone(p2) || !validatePhone(sp)){
    alert("All phone numbers must be exactly 10 digits.");
    return;
  }

  var hst=await generateHST();

  var insertResponse=await client.from("students").insert([{
    hst_number:hst,
    name:document.getElementById("name").value,
    class:document.getElementById("class").value,
    room_no:document.getElementById("room_no").value,
    parent_name:document.getElementById("parent_name").value,
    parent_phone1:p1,
    parent_phone2:p2,
    student_phone:sp,
    photo_url:null
  }]).select();

  if(insertResponse.error){
    alert(insertResponse.error.message);
    return;
  }

  var photoFile=document.getElementById("photo").files[0];

  if(photoFile){
    var compressed=await compressImage(photoFile);
    var fileName=hst+".jpg";

    await client.storage
      .from("student-photos")
      .upload(fileName,compressed,{upsert:true});

    var urlResponse=client.storage
      .from("student-photos")
      .getPublicUrl(fileName);

    var urlData=urlResponse.data;

    await client.from("students")
      .update({photo_url:urlData.publicUrl})
      .eq("id",insertResponse.data[0].id);
  }

  alert("Student Added Successfully!");
  var inputs=document.querySelectorAll("input");
  for(var i=0;i<inputs.length;i++){
    inputs[i].value="";
  }
});
</script>

</body>
</html>
