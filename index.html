<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Add Student</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
*{box-sizing:border-box;}
body{
  margin:0;
  font-family:Arial;
  background:linear-gradient(135deg,#4e73df,#1cc88a);
  display:flex;
  justify-content:center;
  align-items:center;
  min-height:100vh;
  padding:15px;
}
.card{
  background:white;
  width:100%;
  max-width:420px;
  padding:20px;
  border-radius:15px;
  box-shadow:0 10px 25px rgba(0,0,0,0.2);
}
h2{text-align:center;}
input{
  width:100%;
  padding:12px;
  margin-bottom:12px;
  border-radius:8px;
  border:1px solid #ccc;
  font-size:16px;
}
button{
  width:100%;
  padding:14px;
  border:none;
  border-radius:8px;
  font-size:16px;
  font-weight:bold;
  cursor:pointer;
  margin-top:10px;
}
.add{background:#f6c23e;}
.view{background:#36b9cc;color:white;}
</style>
</head>

<body>

<div class="card">
<h2>Add Student</h2>

<input id="name" placeholder="Student Name">
<input id="class" placeholder="Class">
<input id="room_no" placeholder="Room No">
<input id="parent_name" placeholder="Parent Name">

<input id="parent_phone1" placeholder="Parent Phone 1 (10 digits)" maxlength="10">
<input id="parent_phone2" placeholder="Parent Phone 2 (10 digits)" maxlength="10">
<input id="student_phone" placeholder="Student Phone (10 digits)" maxlength="10">

<input type="file" id="photo">

<button id="addBtn" class="add">Add Student</button>
<button class="view" onclick="location.href='view-students.html'">View Students</button>
</div>

<script>
const supabaseUrl="https://nqobmiqnwdldranpyxsl.supabase.co";
const supabaseKey="sb_publishable_eQReGHybx0Oj9G65eqWn-w_x_OjsbWB";
const client=supabase.createClient(supabaseUrl,supabaseKey);

function validatePhone(num){
  return /^[0-9]{10}$/.test(num);
}

async function compressImage(file){
  return new Promise(resolve=>{
    const reader=new FileReader();
    reader.readAsDataURL(file);
    reader.onload=e=>{
      const img=new Image();
      img.src=e.target.result;
      img.onload=()=>{
        const canvas=document.createElement("canvas");
        const ctx=canvas.getContext("2d");
        const maxWidth=500;
        const scale=maxWidth/img.width;
        canvas.width=maxWidth;
        canvas.height=img.height*scale;
        ctx.drawImage(img,0,0,canvas.width,canvas.height);
        canvas.toBlob(blob=>resolve(blob),"image/jpeg",0.7);
      };
    };
  });
}

async function generateHST(){
  const {data}=await client.from("students")
    .select("hst_number")
    .order("id",{ascending:false})
    .limit(1);

  let next=1;
  if(data && data.length>0){
    next=parseInt(data[0].hst_number.replace("HST",""))+1;
  }
  return "HST"+String(next).padStart(3,"0");
}

document.getElementById("addBtn").addEventListener("click", async function(){

  const p1=parent_phone1.value.trim();
  const p2=parent_phone2.value.trim();
  const sp=student_phone.value.trim();

  if(!validatePhone(p1) || !validatePhone(p2) || !validatePhone(sp)){
    alert("All phone numbers must be exactly 10 digits.");
    return;
  }

  const hst=await generateHST();

  const {data,error}=await client.from("students").insert([{
    hst_number:hst,
    name:name.value,
    class:class.value,
    room_no:room_no.value,
    parent_name:parent_name.value,
    parent_phone1:p1,
    parent_phone2:p2,
    student_phone:sp,
    photo_url:null
  }]).select();

  if(error){
    alert(error.message);
    return;
  }

  const photoFile=document.getElementById("photo").files[0];

  if(photoFile){
    const compressed=await compressImage(photoFile);
    const fileName=hst+".jpg";

    await client.storage
      .from("student-photos")
      .upload(fileName,compressed,{upsert:true});

    const {data:urlData}=client.storage
      .from("student-photos")
      .getPublicUrl(fileName);

    await client.from("students")
      .update({photo_url:urlData.publicUrl})
      .eq("id",data[0].id);
  }

  alert("Student Added Successfully!");
  document.querySelectorAll("input").forEach(i=>i.value="");
});
</script>
</body>
</html>
