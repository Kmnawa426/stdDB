<!DOCTYPE html>
<html>
<head>
  <title>Add Student</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body {
      margin: 0;
      font-family: Arial;
      background: linear-gradient(135deg,#4e73df,#1cc88a);
      display:flex;
      justify-content:center;
      align-items:center;
      height:100vh;
    }
    .card{
      background:white;
      padding:25px;
      border-radius:12px;
      width:350px;
      box-shadow:0 10px 25px rgba(0,0,0,0.2);
    }
    h2{text-align:center;}
    input{
      width:100%;
      padding:8px;
      margin-bottom:10px;
    }
    button{
      width:100%;
      padding:10px;
      margin-top:8px;
      cursor:pointer;
      border:none;
      border-radius:6px;
      font-weight:bold;
    }
    .add{background:#f6c23e;}
    .view{background:#36b9cc;color:white;}
  </style>
</head>
<body>

<div class="card">
  <h2>Add Student</h2>

  <input id="name" placeholder="Name">
  <input id="class" placeholder="Class">
  <input id="room_no" placeholder="Room No">
  <input id="address" placeholder="Address">
  <input id="parent_name" placeholder="Parent Name">
  <input id="parent_phone1" placeholder="Contact Number">
  <input type="file" id="photo">

  <button class="add" onclick="addStudent()">Add Student</button>
  <button class="view" onclick="location.href='view-students.html'">View Students</button>
</div>

<script>
const supabaseUrl = "https://nqobmiqnwdldranpyxsl.supabase.co";
const supabaseKey = "sb_publishable_eQReGHybx0Oj9G65eqWn-w_x_OjsbWB";
const client = supabase.createClient(supabaseUrl, supabaseKey);

async function compressImage(file){
  return new Promise(resolve=>{
    const reader=new FileReader();
    reader.readAsDataURL(file);
    reader.onload=e=>{
      const img=new Image();
      img.src=e.target.result;
      img.onload=()=>{
        const canvas=document.createElement("canvas");
        const ctx=canvas.getContext("2d");
        const maxWidth=500;
        const scale=maxWidth/img.width;
        canvas.width=maxWidth;
        canvas.height=img.height*scale;
        ctx.drawImage(img,0,0,canvas.width,canvas.height);
        canvas.toBlob(blob=>resolve(blob),"image/jpeg",0.7);
      };
    };
  });
}

window.addStudent = async function(){

  const photoFile=document.getElementById("photo").files[0];

  if(!photoFile){
    if(!confirm("No image selected. Continue without photo?")) return;
  }

  const {data,error}=await client.from("students").insert([{
    name:name.value,
    class:class.value,
    room_no:room_no.value,
    address:address.value,
    parent_name:parent_name.value,
    parent_phone1:parent_phone1.value,
    photo_url:null,
    status:"present"
  }]).select();

  if(error){alert(error.message);return;}

  if(photoFile){
    const compressed=await compressImage(photoFile);
    const fileName=`student-${data[0].id}-${Date.now()}.jpg`;

    const {error:uploadError}=await client.storage
      .from("student-photos")
      .upload(fileName,compressed);

    if(uploadError){alert(uploadError.message);return;}

    const {data:urlData}=client.storage
      .from("student-photos")
      .getPublicUrl(fileName);

    await client.from("students")
      .update({photo_url:urlData.publicUrl})
      .eq("id",data[0].id);
  }

  alert("Student Added Successfully!");
  document.querySelectorAll("input").forEach(i=>i.value="");
}
</script>

</body>
</html>
