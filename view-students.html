<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Students</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

<style>
*{box-sizing:border-box;}
body{
  margin:0;
  font-family:Arial;
  background:linear-gradient(135deg,#667eea,#764ba2);
  padding:15px;
}
h2{text-align:center;color:white;}
#search{
  width:100%;
  max-width:400px;
  margin:15px auto;
  display:block;
  padding:12px;
  border-radius:8px;
  border:none;
}
.container{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
  gap:15px;
}
.card{
  background:white;
  padding:15px;
  border-radius:12px;
  position:relative;
  text-align:center;
}
.hst{
  position:absolute;
  top:10px;
  right:15px;
  font-weight:bold;
  color:#4e73df;
}
.photo{
  width:100px;
  height:100px;
  border-radius:50%;
  overflow:hidden;
  margin:10px auto;
  background:#ddd;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:40px;
  position:relative;
}
.photo img{
  width:100%;
  height:100%;
  object-fit:cover;
}
.edit{
  position:absolute;
  bottom:0;
  right:0;
  background:#f6c23e;
  border-radius:50%;
  padding:5px;
  font-size:14px;
  cursor:pointer;
}
button{
  padding:8px;
  width:100%;
  border:none;
  border-radius:6px;
  margin-top:8px;
  cursor:pointer;
}
.delete{background:#e74a3b;color:white;}
.nav{background:#1cc88a;color:white;margin-top:20px;}
</style>
</head>

<body>

<h2>Students List</h2>

<input id="search" placeholder="Search by Name or HST">

<div class="container" id="container"></div>

<button class="nav" onclick="location.href='index.html'">Add Student</button>

<script>
var supabaseUrl="https://nqobmiqnwdldranpyxsl.supabase.co";
var supabaseKey="sb_publishable_eQReGHybx0Oj9G65eqWn-w_x_OjsbWB";
var client=supabase.createClient(supabaseUrl,supabaseKey);

var allStudents=[];

async function fetchStudents(){
  var response=await client.from("students").select("*").order("id");
  allStudents=response.data || [];
  displayStudents(allStudents);
}

function displayStudents(students){
  var container=document.getElementById("container");
  container.innerHTML="";

  for(var i=0;i<students.length;i++){
    var s=students[i];
    var div=document.createElement("div");
    div.className="card";

    var imgSection = s.photo_url
      ? '<img src="'+s.photo_url+'">'
      : '+';

    div.innerHTML=
      '<div class="hst">'+s.hst_number+'</div>'+
      '<div class="photo" id="photo_'+s.id+'">'+
        imgSection+
        '<div class="edit">‚úè</div>'+
      '</div>'+
      '<h3>'+s.name+'</h3>'+
      '<p>Class: '+s.class+'</p>'+
      '<p>Room: '+s.room_no+'</p>'+
      '<p>Parent1: '+s.parent_phone1+'</p>'+
      '<p>Parent2: '+s.parent_phone2+'</p>'+
      '<p>Student: '+s.student_phone+'</p>'+
      '<button class="delete">Delete</button>';

    (function(student){
      // Delete
      div.querySelector(".delete").addEventListener("click",function(){
        deleteStudent(student.id,student.photo_url);
      });

      // Edit image
      div.querySelector(".edit").addEventListener("click",function(){
        uploadNewImage(student);
      });

    })(s);

    container.appendChild(div);
  }
}

document.getElementById("search").addEventListener("input",function(){
  var q=this.value.toLowerCase();
  var filtered=[];
  for(var i=0;i<allStudents.length;i++){
    if(allStudents[i].name.toLowerCase().indexOf(q)>-1 ||
       allStudents[i].hst_number.toLowerCase().indexOf(q)>-1){
      filtered.push(allStudents[i]);
    }
  }
  displayStudents(filtered);
});

async function uploadNewImage(student){

  var input=document.createElement("input");
  input.type="file";
  input.accept="image/*";

  input.onchange=async function(){

    var file=input.files[0];
    if(!file) return;

    var fileName=student.hst_number+".jpg";

    await client.storage
      .from("student-photos")
      .upload(fileName,file,{upsert:true});

    var urlResponse=client.storage
      .from("student-photos")
      .getPublicUrl(fileName);

    var urlData=urlResponse.data;

    await client.from("students")
      .update({photo_url:urlData.publicUrl})
      .eq("id",student.id);

    fetchStudents();
  };

  input.click();
}

async function deleteStudent(id,photoUrl){
  if(confirm("Delete this student?")){
    if(photoUrl){
      var parts=photoUrl.split("/student-photos/");
      if(parts.length>1){
        await client.storage.from("student-photos").remove([parts[1]]);
      }
    }
    await client.from("students").delete().eq("id",id);
    fetchStudents();
  }
}

fetchStudents();
</script>

</body>
</html>
