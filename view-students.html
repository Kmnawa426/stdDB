<!DOCTYPE html>
<html>
<head>
  <title>Students</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    body{
      margin:0;
      font-family:Arial;
      background:linear-gradient(135deg,#667eea,#764ba2);
      padding:20px;
      color:white;
    }
    h2{text-align:center;}
    input{
      display:block;
      margin:15px auto;
      padding:8px;
      width:300px;
    }
    .container{
      display:grid;
      grid-template-columns:repeat(auto-fit,minmax(250px,1fr));
      gap:20px;
    }
    .card{
      background:white;
      color:black;
      padding:15px;
      border-radius:10px;
      text-align:center;
      position:relative;
    }
    .photo{
      width:100px;
      height:100px;
      border-radius:50%;
      overflow:hidden;
      margin:auto;
      background:#ddd;
      display:flex;
      align-items:center;
      justify-content:center;
      font-size:40px;
      cursor:pointer;
    }
    .photo img{
      width:100%;
      height:100%;
      object-fit:cover;
    }
    .edit{
      position:absolute;
      top:10px;
      right:10px;
      cursor:pointer;
      background:black;
      color:white;
      padding:5px 8px;
      border-radius:50%;
    }
    button{
      margin-top:8px;
      padding:6px;
      width:100%;
      cursor:pointer;
      border:none;
      border-radius:6px;
    }
    .delete{background:#e74a3b;color:white;}
    .nav{background:#1cc88a;color:white;margin-top:20px;}
  </style>
</head>
<body>

<h2>Students List</h2>

<input id="search" placeholder="Search by Name or Room No" onkeyup="searchStudents()">

<div class="container" id="container"></div>

<button class="nav" onclick="location.href='index.html'">Add Student</button>

<script>
const supabaseUrl="https://nqobmiqnwdldranpyxsl.supabase.co";
const supabaseKey="sb_publishable_eQReGHybx0Oj9G65eqWn-w_x_OjsbWB";
const client=supabase.createClient(supabaseUrl,supabaseKey);

let allStudents=[];

async function fetchStudents(){
  const {data}=await client.from("students").select("*").order("created_at");
  allStudents=data;
  displayStudents(data);
}

function displayStudents(students){
  container.innerHTML="";
  students.forEach(s=>{
    const div=document.createElement("div");
    div.className="card";

    let photoSection="";
    if(s.photo_url){
      photoSection=`
        <div class="photo"><img src="${s.photo_url}"></div>
        <div class="edit" onclick="triggerUpload(${s.id})">‚úè</div>
      `;
    }else{
      photoSection=`
        <div class="photo" onclick="triggerUpload(${s.id})">+</div>
      `;
    }

    div.innerHTML=`
      ${photoSection}
      <h3>${s.name}</h3>
      <p>Room: ${s.room_no}</p>
      <p>Contact: ${s.parent_phone1}</p>
      <button class="delete" onclick="deleteStudent(${s.id},'${s.photo_url || ""}')">Delete</button>
      <input type="file" id="file-${s.id}" style="display:none" onchange="uploadImage(event,${s.id})">
    `;
    container.appendChild(div);
  });
}

function searchStudents(){
  const q=search.value.toLowerCase();
  const filtered=allStudents.filter(s=>
    s.name.toLowerCase().includes(q)||
    s.room_no.toLowerCase().includes(q)
  );
  displayStudents(filtered);
}

function triggerUpload(id){
  document.getElementById("file-"+id).click();
}

async function uploadImage(e,id){
  const file=e.target.files[0];
  if(!file)return;

  const fileName=`student-${id}-${Date.now()}.jpg`;

  await client.storage.from("student-photos").upload(fileName,file);

  const {data}=client.storage.from("student-photos").getPublicUrl(fileName);

  await client.from("students")
    .update({photo_url:data.publicUrl})
    .eq("id",id);

  fetchStudents();
}

async function deleteStudent(id,photoUrl){
  if(confirm("Delete this student?")){
    if(photoUrl){
      const path=photoUrl.split("/student-photos/")[1];
      await client.storage.from("student-photos").remove([path]);
    }
    await client.from("students").delete().eq("id",id);
    fetchStudents();
  }
}

fetchStudents();
</script>

</body>
</html>
