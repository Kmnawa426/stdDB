<!DOCTYPE html>
<html>
<head>
  <title>Students List</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #667eea, #764ba2);
      padding: 30px;
      color: white;
    }

    h2 {
      text-align: center;
    }

    .container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-top: 30px;
    }

    .student-card {
      background: rgba(255,255,255,0.15);
      backdrop-filter: blur(12px);
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.2);
      text-align: center;
    }

    .photo-box {
      width: 100px;
      height: 100px;
      margin: 0 auto 10px auto;
      border-radius: 50%;
      background: rgba(255,255,255,0.3);
      display: flex;
      justify-content: center;
      align-items: center;
      overflow: hidden;
      cursor: pointer;
      font-size: 40px;
      font-weight: bold;
    }

    .photo-box img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .delete-btn {
      margin-top: 10px;
      padding: 8px;
      border: none;
      border-radius: 8px;
      background: #e74a3b;
      color: white;
      cursor: pointer;
      width: 100%;
    }
  </style>
</head>
<body>

<h2>Students List</h2>

<div class="container" id="studentsContainer"></div>

<script>
const supabaseUrl = "https://nqobmiqnwdldranpyxsl.supabase.co";
const supabaseKey = "sb_publishable_eQReGHybx0Oj9G65eqWn-w_x_OjsbWB";
const client = supabase.createClient(supabaseUrl, supabaseKey);

async function fetchStudents(){
  const { data } = await client
    .from("students")
    .select("*")
    .order("created_at", { ascending: true });

  const container = document.getElementById("studentsContainer");
  container.innerHTML = "";

  data.forEach(student => {

    const div = document.createElement("div");
    div.className = "student-card";

    const photoHTML = student.photo_url
      ? `<img src="${student.photo_url}">`
      : `+`;

    div.innerHTML = `
      <div class="photo-box" onclick="triggerUpload(${student.id})">
        ${photoHTML}
      </div>

      <h3>${student.name}</h3>
      <p><b>Room:</b> ${student.room_no}</p>
      <button class="delete-btn" onclick="deleteStudent(${student.id})">Delete</button>

      <input type="file" id="file-${student.id}" 
             style="display:none" 
             accept="image/*"
             onchange="uploadImage(event, ${student.id})">
    `;

    container.appendChild(div);
  });
}

// Trigger file input
window.triggerUpload = function(id){
  document.getElementById("file-" + id).click();
}

// Upload image to storage
window.uploadImage = async function(event, studentId){
  const file = event.target.files[0];
  if(!file) return;

  const fileName = `student-${studentId}-${Date.now()}.jpg`;

  const { error } = await client.storage
    .from("student-photos")
    .upload(fileName, file);

  if(error){
    alert("Upload failed");
    return;
  }

  const { data } = client.storage
    .from("student-photos")
    .getPublicUrl(fileName);

  await client
    .from("students")
    .update({ photo_url: data.publicUrl })
    .eq("id", studentId);

  fetchStudents();
}

// Delete
window.deleteStudent = async function(id){
  if(confirm("Delete this student?")){
    await client.from("students").delete().eq("id", id);
    fetchStudents();
  }
}

fetchStudents();
</script>

</body>
</html>
