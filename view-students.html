<!DOCTYPE html>
<html>
<head>
  <title>Students List</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

  <style>
    body {
      margin: 0;
      font-family: 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #667eea, #764ba2);
      padding: 30px;
      color: white;
    }

    h2 { text-align: center; }

    .container {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 25px;
      margin-top: 30px;
    }

    .student-card {
      background: rgba(255,255,255,0.15);
      backdrop-filter: blur(12px);
      padding: 20px;
      border-radius: 15px;
      box-shadow: 0 6px 20px rgba(0,0,0,0.2);
      text-align: center;
      position: relative;
    }

    .photo-box {
      width: 110px;
      height: 110px;
      margin: 0 auto 15px auto;
      border-radius: 50%;
      background: rgba(255,255,255,0.3);
      display: flex;
      justify-content: center;
      align-items: center;
      overflow: hidden;
      font-size: 40px;
      cursor: pointer;
    }

    .photo-box img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .edit-icon {
      position: absolute;
      top: 15px;
      right: 15px;
      cursor: pointer;
      font-size: 16px;
      background: white;
      color: black;
      padding: 5px 8px;
      border-radius: 50%;
    }

    .delete-btn, .nav-btn {
      margin-top: 10px;
      padding: 8px;
      border-radius: 8px;
      border: none;
      cursor: pointer;
      width: 100%;
    }

    .delete-btn { background: #e74a3b; color: white; }
    .nav-btn { background: #1cc88a; color: white; }
  </style>
</head>
<body>

<h2>Students List</h2>

<div class="container" id="studentsContainer"></div>

<button class="nav-btn" onclick="goToAdd()">Go To Add Student</button>

<script>
const supabaseUrl = "https://nqobmiqnwdldranpyxsl.supabase.co";
const supabaseKey = "sb_publishable_eQReGHybx0Oj9G65eqWn-w_x_OjsbWB";
const client = supabase.createClient(supabaseUrl, supabaseKey);

async function fetchStudents(){
  const { data } = await client
    .from("students")
    .select("*")
    .order("created_at", { ascending: true });

  const container = document.getElementById("studentsContainer");
  container.innerHTML = "";

  data.forEach(student => {

    const div = document.createElement("div");
    div.className = "student-card";

    let photoSection = "";

    if(student.photo_url){
      photoSection = `
        <div class="photo-box">
          <img src="${student.photo_url}">
        </div>
        <div class="edit-icon" onclick="triggerUpload(${student.id})">‚úè</div>
      `;
    } else {
      photoSection = `
        <div class="photo-box" onclick="triggerUpload(${student.id})">
          +
        </div>
      `;
    }

    div.innerHTML = `
      ${photoSection}
      <h3>${student.name}</h3>
      <p><b>Room:</b> ${student.room_no}</p>
      <p><b>Contact:</b> ${student.parent_phone1}</p>
      <button class="delete-btn" onclick="deleteStudent(${student.id})">Delete</button>
      <input type="file"
             id="file-${student.id}"
             style="display:none"
             accept="image/*"
             onchange="uploadImage(event, ${student.id})">
    `;

    container.appendChild(div);
  });
}

window.triggerUpload = function(id){
  document.getElementById("file-" + id).click();
}

window.uploadImage = async function(event, studentId){
  const file = event.target.files[0];
  if(!file) return;

  const fileName = `student-${studentId}-${Date.now()}.jpg`;

  await client.storage
    .from("student-photos")
    .upload(fileName, file);

  const { data } = client.storage
    .from("student-photos")
    .getPublicUrl(fileName);

  await client
    .from("students")
    .update({ photo_url: data.publicUrl })
    .eq("id", studentId);

  fetchStudents();
}

window.deleteStudent = async function(id){
  if(confirm("Delete this student?")){
    await client.from("students").delete().eq("id", id);
    fetchStudents();
  }
}

window.goToAdd = function(){
  window.location.href = "index.html";
}

fetchStudents();
</script>

</body>
</html>
